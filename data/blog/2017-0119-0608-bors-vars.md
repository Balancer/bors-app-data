---
Date: 2017-01-19 06:08:56 +0300
Author: Balancer <balancer@balancer.ru>
---

# Продолжение рефакторинга

## Переменные среды

Переменные `bors_var` сделаны сменными пакетами. Оригинальный `bors_var`,
работающий с MySQL, вынесен в пакет `balancer/bors-vars-db`. Также
добавлен для тестовых целей (и для облегчённых/упрощённых проектов)
вариант с сохранением переменных в файлы — `balancer/bors-vars-files`.
Данные сохраняются в подкаталог `data` в каталоге `composer`.

С этим есть небольшая техническая сложность. Я не знаю, как заставить
composer ставить один из пакетов на выбор автоматом. Поэтому
`balancer/bors-core` просто требует зависимость `balancer/bors-vars`,
которую обеспечивает любой из этих пакетов. Но сам загрузить не может.
Так что один из указанных пакетов надо загружать вручную.

## Миграции

Продолжается зачистка `bors-core`. Вынесены не нужные в любом проекте
`balancer/bors-thumb-votes` и `balancer/bors-keywords`. Что интересно, с
этими пакетами производятся тесты с миграциями. Используется
[robmorgan/phinx](https://phinx.org/). Сами миграции работают
превосходно. Но есть небольшая концептуальная проблема. Каждый пакет
может использоваться независимо. Может обновляться независимо. Может
использовать разные БД. Поэтому общея таблицей миграции не обойтись. Даже
когда речь об одной БД. В итоге приходится для каждого пакета заводить
свою собственную таблицу миграций. Выглядит как-то не очень аккуратно.
Может, миграции хранить не в БД пакета, а в SQLite в `composer/data`?

## Роутинг

Теперь можно задавать прямой роутинг к классу прямо в инициации
приложения в загрузчике. По классическому принципу `url_map.php`, т.е. с множественными масками. Примерно так:
```php
B2\Dev\Site::instance()
	->debug()
	->reg_url('/test/page', \Test\Page::class)
	->run();
```
